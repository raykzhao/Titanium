/* ****************************** *
 * Titanium_CPA_lite              *
 * Implemented by Raymond K. ZHAO *
 *                                *
 * NTT functions                  *
 * ****************************** */
 
#include "param.h"
#include "ntt.h"
#include "fastmodulo.h"
#include <stdint.h>
#include <x86intrin.h>

/* 768=3*256 */
#define N1_768 3
#define N2_768 256

/* 1280=5*256 */
#define N1_1280 5
#define N2_1280 256

/* 1536=6*256 */
#define N1_1536 6
#define N2_1536 256

/* multiplication inverses of 768, 1280, 1536 (in Montgomery form) */
#define INV_768 28843
#define INV_1280 34202
#define INV_1536 56662

/* omega_n: n-th root of unity mod Q */
static const __m256i w_3[2]={{7706,7706,7706,7706},{76774,76774,76774,76774}};

static const __m256i w_5[4][4]={{{42831,42831,42831,42831},{74127,74127,74127,74127},{53076,53076,53076,53076},{83408,83408,83408,83408}},
{{74127,74127,74127,74127},{83408,83408,83408,83408},{42831,42831,42831,42831},{53076,53076,53076,53076}},
{{53076,53076,53076,53076},{42831,42831,42831,42831},{83408,83408,83408,83408},{74127,74127,74127,74127}},
{{83408,83408,83408,83408},{53076,53076,53076,53076},{74127,74127,74127,74127},{42831,42831,42831,42831}}};

static const __m256i w_6[5][5]={{{7707,7707,7707,7707},{7706,7706,7706,7706},{84480,84480,84480,84480},{76774,76774,76774,76774},{76775,76775,76775,76775}},
{{7706,7706,7706,7706},{76774,76774,76774,76774},{1,1,1,1},{7706,7706,7706,7706},{76774,76774,76774,76774}},
{{84480,84480,84480,84480},{1,1,1,1},{84480,84480,84480,84480},{1,1,1,1},{84480,84480,84480,84480}},
{{76774,76774,76774,76774},{7706,7706,7706,7706},{1,1,1,1},{76774,76774,76774,76774},{7706,7706,7706,7706}},
{{76775,76775,76775,76775},{76774,76774,76774,76774},{84480,84480,84480,84480},{7706,7706,7706,7706},{7707,7707,7707,7707}}};

/* omega_256,768,1280,1536, respectively (in Montgomery form) */
static const uint64_t omega_256[128]={17402,180,54180,3347,78156,39238,67779,41558,5770,47150,83823,55385,28128,18428,55563,81706,9535,82162,62310,528,74447,21082,9607,19353,80545,82479,73246,81986,9334,21661,14924,14631,10919,76341,84290,26990,13814,18445,60680,16784,67605,73665,39143,39184,51525,49002,49908,69171,38145,76710,26397,4283,21968,22850,34889,25945,37193,43601,29346,47122,75395,52987,66659,42362,78812,67732,27411,56054,60535,57620,25015,10706,12228,47945,69675,20887,35393,8687,80357,25891,20939,51045,73484,69143,29717,74312,64928,28217,45217,8876,52765,84318,35418,16212,64395,36746,78016,81579,55789,65251,40959,78914,13953,60284,66550,9553,3099,3508,42136,10786,36308,30659,19930,779,65517,36544,17214,28073,1873,56887,57825,2239,82572,16758,59779,83507,44750,37271};
static const uint64_t omega_768[768]={17402,67671,65348,180,9050,70156,54180,20658,81187,3347,50945,22278,78156,43384,31679,39238,48510,73507,67779,70778,76066,41558,14966,1515,5770,27273,33610,47150,14516,63371,83823,60785,66446,55385,48389,62730,28128,34357,42467,18428,34775,25936,55563,76112,34484,81706,15361,73002,9535,61687,8542,82162,66448,36712,62310,63332,67782,528,54707,42461,74447,77493,24130,21082,8637,82245,9607,65307,2812,19353,57815,1602,80545,83710,59797,82479,21372,4444,73246,12416,70429,81986,20052,78879,9334,37501,3418,21661,51828,15046,14924,55724,51353,14631,45686,81711,10919,65564,11040,76341,50691,28281,84290,51411,64481,26990,14688,62632,13814,28076,12969,18445,2776,17543,60680,75247,42621,16784,8439,72290,67605,5709,47673,73665,28789,72284,39143,48427,45867,39184,45795,35564,51525,13892,60158,49002,41923,28624,49908,31154,83243,69171,84444,49767,38145,73344,26730,76710,27003,20035,26397,17727,32384,4283,13524,32269,21968,15636,82135,22850,59981,54183,34889,59828,4250,25945,13775,12035,37193,6706,74333,43601,75443,71249,29346,67435,72256,47122,22495,37439,75395,12515,33166,52987,49851,14208,66659,52014,52558,42362,27229,22011,78812,1272,35793,67732,44948,44606,27411,12388,78408,56054,11624,30609,60535,35103,4880,57620,5878,32703,25015,79658,43807,10706,68935,6871,12228,51590,40627,47945,68567,63463,69675,25303,9657,20887,12913,34403,35393,687,48621,8687,37825,19708,80357,64871,18438,25891,11060,58573,20939,34301,58425,51045,17919,13877,73484,71316,37408,69143,7942,23835,29717,25074,77931,74312,28465,55994,64928,35384,42475,28217,5978,28344,45217,25277,83444,8876,5087,25787,52765,10529,74116,84318,43432,5932,35418,62958,11431,16212,26614,61491,64395,69600,7452,36746,82793,46546,78016,83279,70981,81579,60603,76069,55789,78088,2418,65251,18770,51970,40959,74024,13985,78914,62721,69916,13953,39758,8947,60284,55337,74136,66550,13680,11952,9553,62592,49350,3099,929,70175,3508,26186,2425,42136,25253,54077,10786,82344,56825,36308,32611,39163,30659,16115,45204,19930,35198,4963,779,34473,57686,65517,69691,44881,36544,25703,76702,17214,48832,23989,28073,83219,39804,1873,42543,69183,56887,48812,41757,57825,77199,65669,2239,4624,82296,82572,40128,18163,16758,82226,60279,59779,81574,65045,83507,54284,63434,44750,34651,928,37271,38788,25885,67079,16810,19133,84301,75431,14325,30301,63823,3294,81134,33536,62203,6325,41097,52802,45243,35971,10974,16702,13703,8415,42923,69515,82966,78711,57208,50871,37331,69965,21110,658,23696,18035,29096,36092,21751,56353,50124,42014,66053,49706,58545,28918,8369,49997,2775,69120,11479,74946,22794,75939,2319,18033,47769,22171,21149,16699,83953,29774,42020,10034,6988,60351,63399,75844,2236,74874,19174,81669,65128,26666,82879,3936,771,24684,2002,63109,80037,11235,72065,14052,2495,64429,5602,75147,46980,81063,62820,32653,69435,69557,28757,33128,69850,38795,2770,73562,18917,73441,8140,33790,56200,191,33070,20000,57491,69793,21849,70667,56405,71512,66036,81705,66938,23801,9234,41860,67697,76042,12191,16876,78772,36808,10816,55692,12197,45338,36054,38614,45297,38686,48917,32956,70589,24323,35479,42558,55857,34573,53327,1238,15310,37,34714,46336,11137,57751,7771,57478,64446,58084,66754,52097,80198,70957,52212,62513,68845,2346,61631,24500,30298,49592,24653,80231,58536,70706,72446,47288,77775,10148,40880,9038,13232,55135,17046,12225,37359,61986,47042,9086,71966,51315,31494,34630,70273,17822,32467,31923,42119,57252,62470,5669,83209,48688,16749,39533,39875,57070,72093,6073,28427,72857,53872,23946,49378,79601,26861,78603,51778,59466,4823,40674,73775,15546,77610,72253,32891,43854,36536,15914,21018,14806,59178,74824,63594,71568,50078,49088,83794,35860,75794,46656,64773,4124,19610,66043,58590,73421,25908,63542,50180,26056,33436,66562,70604,10997,13165,47073,15338,76539,60646,54764,59407,6550,10169,56016,28487,19553,49097,42006,56264,78503,56137,39264,59204,1037,75605,79394,58694,31716,73952,10365,163,41049,78549,49063,21523,73050,68269,57867,22990,20086,14881,77029,47735,1688,37935,6465,1202,13500,2902,23878,8412,28692,6393,82063,19230,65711,32511,43522,10457,70496,5567,21760,14565,70528,44723,75534,24197,29144,10345,17931,70801,72529,74928,21889,35131,81382,83552,14306,80973,58295,82056,42345,59228,30404,73695,2137,27656,48173,51870,45318,53822,68366,39277,64551,49283,79518,83702,50008,26795,18964,14790,39600,47937,58778,7779,67267,35649,60492,56408,1262,44677,82608,41938,15298,27594,35669,42724,26656,7282,18812,82242,79857,2185,1909,44353,66318,67723,2255,24202,24702,2907,19436,974,30197,21047,39731,49830,83553,47210,45693,58596};
static const uint64_t omega_1280[1280]={17402,65908,3147,190,83016,180,69754,17956,57190,65921,54180,44666,82453,64547,73667,3347,11987,65420,82498,39745,78156,59885,7347,78965,51424,39238,30932,14941,29304,18601,67779,17622,19748,34480,23155,41558,66400,30478,71798,42213,5770,48884,49930,68543,33963,47150,14390,75793,18079,662,83823,22859,3823,34995,30300,55385,37598,52470,57851,80833,28128,81025,80004,10065,205,18428,57997,4119,72730,61705,55563,54011,57085,11151,71866,81706,36959,32942,61692,4530,9535,57648,31265,67953,11834,82162,33443,33374,9451,13832,62310,13104,76816,56878,23863,528,58178,58303,55116,1878,74447,24011,61636,31640,58392,21082,46426,51097,61768,3944,9607,34861,4655,6348,4410,19353,17517,49459,52166,60195,80545,34795,18503,72981,39761,82479,82132,78138,2221,56240,73246,53280,33820,77154,32040,81986,70371,42100,75560,13206,9334,61421,84431,18171,4399,21661,70863,69431,62687,56884,14924,40551,31924,29524,56922,14631,40587,62771,16219,68360,10919,51423,54808,66502,47477,76341,18300,23413,79586,13288,84290,17035,35390,47263,29081,26990,58675,7784,33355,51838,13814,4646,61997,71097,58734,18445,46750,75277,26504,22405,60680,47904,17469,36490,69906,16784,57334,20347,960,5937,67605,23410,41815,35517,12936,73665,34487,83127,46011,7610,39143,73905,14851,78908,9623,39184,26902,77139,12147,24169,51525,71807,71045,23564,9503,49002,71252,10852,80841,72530,49908,73159,56174,2613,35432,69171,55799,12174,26184,20426,38145,68261,31691,24651,65594,76710,17678,77119,70104,59721,26397,83256,65025,65535,66049,4283,53680,57414,41962,27714,21968,21809,47490,42893,62776,22850,59472,17201,69681,56313,34889,75581,24160,22693,54013,25945,24492,6794,72113,37561,37193,22245,17450,78877,69888,43601,21746,14628,2816,519,29346,40509,10016,2806,71738,47122,27945,57981,84277,50483,75395,47826,49195,23077,73284,52987,33856,23520,18735,8943,66659,52936,67597,63489,72932,42362,51308,71257,17483,71953,78812,68166,74664,24561,30717,67732,73564,1918,43014,37388,27411,8742,70432,21621,17815,56054,12431,79782,2884,40012,60535,24567,21778,23274,47310,57620,44820,50141,78032,47502,25015,58341,54823,1914,20813,10706,73074,27928,69228,13119,12228,30214,42709,55302,62693,47945,54947,14297,3145,31330,69675,65252,79347,17354,52939,20887,41260,59805,70213,52211,35393,553,6852,13863,2045,8687,81972,34908,33194,24178,80357,5120,31664,22636,12212,25891,20462,68992,54956,43129,20939,76430,68747,67961,56236,51045,26598,79483,11859,30836,73484,64784,16260,21357,73207,69143,69354,78843,7901,70247,29717,8747,77063,12733,24097,74312,13936,48169,30988,72312,64928,55167,52618,34478,54295,28217,46991,40071,71196,37962,45217,35964,65069,56303,21627,8876,11596,70658,51003,4690,52765,26675,63327,60842,59994,84318,3480,53202,65546,63741,35418,33708,46893,45273,8854,16212,8388,6466,25732,46143,64395,74839,3203,57561,34159,36746,54593,34812,7256,59658,78016,43179,2768,72031,47086,81579,71286,72839,54195,64559,55789,83393,43960,7862,1629,65251,10436,52924,994,67924,40959,15439,47696,45751,722,78914,684,79207,648,48360,13953,36922,17665,26086,25628,60284,46511,79343,79634,26257,66550,60446,58601,61711,46624,9553,30831,66853,73672,9978,3099,71702,16275,41250,46543,3508,39647,83358,82024,70078,42136,21926,84382,20772,57709,10786,10208,54682,778,51804,36308,31292,69968,65216,48500,30659,41501,24599,30424,67768,19930,73094,54452,33676,38247,779,36234,738,83237,22931,65517,8385,53176,47961,59270,36544,73936,39067,74491,14779,17214,36233,16308,34326,55467,28073,8084,8810,25444,52810,1873,67816,32899,55354,13382,56887,52695,18322,18797,57375,57825,63248,23657,82151,35751,2239,29423,24353,58999,31964,82572,70299,64887,17689,74811,16758,39749,15876,2086,46165,59779,52628,47740,36519,40781,83507,43081,7970,9689,25336,44750,41788,33502,44035,22846,37271,75000,30863,75499,33685,67079,18573,81334,84291,1465,84301,14727,66525,27291,18560,30301,39815,2028,19934,10814,81134,72494,19061,1983,44736,6325,24596,77134,5516,33057,45243,53549,69540,55177,65880,16702,66859,64733,50001,61326,42923,18081,54003,12683,42268,78711,35597,34551,15938,50518,37331,70091,8688,66402,83819,658,61622,80658,49486,54181,29096,46883,32011,26630,3648,56353,3456,4477,74416,84276,66053,26484,80362,11751,22776,28918,30470,27396,73330,12615,2775,47522,51539,22789,79951,74946,26833,53216,16528,72647,2319,51038,51107,75030,70649,22171,71377,7665,27603,60618,83953,26303,26178,29365,82603,10034,60470,22845,52841,26089,63399,38055,33384,22713,80537,74874,49620,79826,78133,80071,65128,66964,35022,32315,24286,3936,49686,65978,11500,44720,2002,2349,6343,82260,28241,11235,31201,50661,7327,52441,2495,14110,42381,8921,71275,75147,23060,50,66310,80082,62820,13618,15050,21794,27597,69557,43930,52557,54957,27559,69850,43894,21710,68262,16121,73562,33058,29673,17979,37004,8140,66181,61068,4895,71193,191,67446,49091,37218,55400,57491,25806,76697,51126,32643,70667,79835,22484,13384,25747,66036,37731,9204,57977,62076,23801,36577,67012,47991,14575,67697,27147,64134,83521,78544,16876,61071,42666,48964,71545,10816,49994,1354,38470,76871,45338,10576,69630,5573,74858,45297,57579,7342,72334,60312,32956,12674,13436,60917,74978,35479,13229,73629,3640,11951,34573,11322,28307,81868,49049,15310,28682,72307,58297,64055,46336,16220,52790,59830,18887,7771,66803,7362,14377,24760,58084,1225,19456,18946,18432,80198,30801,27067,42519,56767,62513,62672,36991,41588,21705,61631,25009,67280,14800,28168,49592,8900,60321,61788,30468,58536,59989,77687,12368,46920,47288,62236,67031,5604,14593,40880,62735,69853,81665,83962,55135,43972,74465,81675,12743,37359,56536,26500,204,33998,9086,36655,35286,61404,11197,31494,50625,60961,65746,75538,17822,31545,16884,20992,11549,42119,33173,13224,66998,12528,5669,16315,9817,59920,53764,16749,10917,82563,41467,47093,57070,75739,14049,62860,66666,28427,72050,4699,81597,44469,23946,59914,62703,61207,37171,26861,39661,34340,6449,36979,59466,26140,29658,82567,63668,73775,11407,56553,15253,71362,72253,54267,41772,29179,21788,36536,29534,70184,81336,53151,14806,19229,5134,67127,31542,63594,43221,24676,14268,32270,49088,83928,77629,70618,82436,75794,2509,49573,51287,60303,4124,79361,52817,61845,72269,58590,64019,15489,29525,41352,63542,8051,15734,16520,28245,33436,57883,4998,72622,53645,10997,19697,68221,63124,11274,15338,15127,5638,76580,14234,54764,75734,7418,71748,60384,10169,70545,36312,53493,12169,19553,29314,31863,50003,30186,56264,37490,44410,13285,46519,39264,48517,19412,28178,62854,75605,72885,13823,33478,79791,31716,57806,21154,23639,24487,163,81001,31279,18935,20740,49063,50773,37588,39208,75627,68269,76093,78015,58749,38338,20086,9642,81278,26920,50322,47735,29888,49669,77225,24823,6465,41302,81713,12450,37395,2902,13195,11642,30286,19922,28692,1088,40521,76619,82852,19230,74045,31557,83487,16557,43522,69042,36785,38730,83759,5567,83797,5274,83833,36121,70528,47559,66816,58395,58853,24197,37970,5138,4847,58224,17931,24035,25880,22770,37857,74928,53650,17628,10809,74503,81382,12779,68206,43231,37938,80973,44834,1123,2457,14403,42345,62555,99,63709,26772,73695,74273,29799,83703,32677,48173,53189,14513,19265,35981,53822,42980,59882,54057,16713,64551,11387,30029,50805,46234,83702,48247,83743,1244,61550,18964,76096,31305,36520,25211,47937,10545,45414,9990,69702,67267,48248,68173,50155,29014,56408,76397,75671,59037,31671,82608,16665,51582,29127,71099,27594,31786,66159,65684,27106,26656,21233,60824,2330,48730,82242,55058,60128,25482,52517,1909,14182,19594,66792,9670,67723,44732,68605,82395,38316,24702,31853,36741,47962,43700,974,41400,76511,74792,59145,39731,42693,50979,40446,61635,47210,9481,53618,8982,50796};
static const uint64_t omega_1536[1536]={17402,80556,67671,23249,65348,9641,180,1309,9050,70507,70156,29587,54180,56085,20658,17876,81187,35182,3347,69866,50945,58373,22278,29657,78156,78378,43384,82706,31679,56252,39238,21579,48510,57092,73507,35652,67779,74723,70778,35049,76066,2165,41558,19677,14966,74105,1515,60298,5770,9107,27273,2621,33610,70764,47150,37815,14516,28592,63371,10752,83823,61861,60785,73611,66446,26074,55385,34341,48389,22889,62730,76022,28128,29959,34357,46628,42467,72752,18428,62673,34775,11182,25936,17773,55563,25310,76112,71023,34484,27370,81706,15020,15361,4230,73002,43713,9535,43527,61687,6015,8542,63058,82162,7072,66448,36414,36712,56714,62310,16647,63332,62565,67782,5752,528,26368,54707,77283,42461,41732,74447,80035,77493,29908,24130,58144,21082,13450,8637,47322,82245,13777,9607,77843,65307,51114,2812,7308,19353,29506,57815,9772,1602,3202,80545,10801,83710,69018,59797,34511,82479,40823,21372,76573,4444,81129,73246,37978,12416,69641,70429,4820,81986,26443,20052,10653,78879,14643,9334,18129,37501,80756,3418,14531,21661,50045,51828,61509,15046,65300,14924,25927,55724,12870,51353,55708,14631,31775,45686,72225,81711,40870,10919,17922,65564,28108,11040,52125,76341,72219,50691,12408,28281,60640,84290,26302,51411,17644,64481,4744,26990,60169,14688,73022,62632,76248,13814,31935,28076,14562,12969,56297,18445,66082,2776,74631,17543,49197,60680,37647,75247,76466,42621,24122,16784,11293,8439,37434,72290,79837,67605,19953,5709,31661,47673,38333,73665,7702,28789,68089,72284,48817,39143,37315,48427,50387,45867,78704,39184,80323,45795,44388,35564,35224,51525,15657,13892,12790,60158,42299,49002,66302,41923,48145,28624,59849,49908,19386,31154,45394,83243,20096,69171,5997,84444,62153,49767,50745,38145,30996,73344,37752,26730,67665,76710,36886,27003,42898,20035,7244,26397,35675,17727,71186,32384,68419,4283,9088,13524,53293,32269,65236,21968,32096,15636,74284,82135,36444,22850,30062,59981,56500,54183,71595,34889,9195,59828,25819,4250,7440,25945,64303,13775,83748,12035,42934,37193,9054,6706,32810,74333,82022,43601,21862,75443,76014,71249,20170,29346,75425,67435,70344,72256,73019,47122,62017,22495,53294,37439,13659,75395,81297,12515,74585,33166,56271,52987,55388,49851,62620,14208,41371,66659,29031,52014,9357,52558,33964,42362,36788,27229,28584,22011,963,78812,6177,1272,71203,35793,36420,67732,695,44948,58410,44606,64371,27411,40233,12388,9362,78408,29522,56054,29350,11624,30089,30609,15617,60535,48326,35103,17322,4880,54262,57620,15394,5878,60581,32703,28029,25015,71620,79658,71466,43807,73110,10706,14965,68935,53092,6871,41050,12228,26972,51590,13783,40627,21824,47945,8396,68567,9114,63463,63987,69675,77247,25303,39922,9657,82900,20887,19072,12913,20220,34403,31005,35393,80445,687,3588,48621,39595,8687,52379,37825,66216,19708,6274,80357,52613,64871,77981,18438,29892,25891,38566,11060,71044,58573,42506,20939,34469,34301,10551,58425,37675,51045,68487,17919,50054,13877,19721,73484,1223,71316,28636,37408,22351,69143,30199,7942,2374,23835,53652,29717,50432,25074,38726,77931,13381,74312,57933,28465,82629,55994,57074,64928,34747,35384,33915,42475,29631,28217,67684,5978,70695,28344,48426,45217,12963,25277,74464,83444,45494,8876,15737,5087,26199,25787,7772,52765,5901,10529,29166,74116,58385,84318,2100,43432,77423,5932,1837,35418,40733,62958,72048,11431,46051,16212,10888,26614,59312,61491,6467,64395,67010,69600,27421,7452,3504,36746,63532,82793,59064,46546,40932,78016,30426,83279,37254,70981,70787,81579,34278,60603,61962,76069,17675,55789,10996,78088,64742,2418,82353,65251,15037,18770,56712,51970,35320,40959,48644,74024,5150,13985,71195,78914,26631,62721,29492,69916,56002,13953,74717,39758,6587,8947,44883,60284,17871,55337,39624,74136,77304,66550,56868,13680,15003,11952,36229,9553,52106,62592,38410,49350,6880,3099,54921,929,71994,70175,43336,3508,57426,26186,43058,2425,34062,42136,51102,25253,34865,54077,30461,10786,6160,82344,18721,56825,44813,36308,80059,32611,59275,39163,56234,30659,20674,16115,16284,45204,30234,19930,55761,35198,1586,4963,60967,779,56823,34473,54981,57686,18690,65517,38561,69691,75486,44881,49944,36544,32964,25703,80378,76702,80007,17214,37887,48832,32212,23989,5022,28073,83533,83219,64978,39804,75445,1873,52576,42543,43267,69183,68037,56887,27429,48812,13293,41757,34735,57825,61472,77199,30586,65669,64072,2239,1733,4624,82438,82296,24004,82572,14747,40128,60905,18163,44319,16758,45835,82226,28,60279,76502,59779,25932,81574,8428,65045,48270,83507,33280,54284,2398,63434,83019,44750,48522,34651,45950,928,66824,37271,74390,38788,60547,25885,7546,67079,3925,16810,61232,19133,74840,84301,83172,75431,13974,14325,54894,30301,28396,63823,66605,3294,49299,81134,14615,33536,26108,62203,54824,6325,6103,41097,1775,52802,28229,45243,62902,35971,27389,10974,48829,16702,9758,13703,49432,8415,82316,42923,64804,69515,10376,82966,24183,78711,75374,57208,81860,50871,13717,37331,46666,69965,55889,21110,73729,658,22620,23696,10870,18035,58407,29096,50140,36092,61592,21751,8459,56353,54522,50124,37853,42014,11729,66053,21808,49706,73299,58545,66708,28918,59171,8369,13458,49997,57111,2775,69461,69120,80251,11479,40768,74946,40954,22794,78466,75939,21423,2319,77409,18033,48067,47769,27767,22171,67834,21149,21916,16699,78729,83953,58113,29774,7198,42020,42749,10034,4446,6988,54573,60351,26337,63399,71031,75844,37159,2236,70704,74874,6638,19174,33367,81669,77173,65128,54975,26666,74709,82879,81279,3936,73680,771,15463,24684,49970,2002,43658,63109,7908,80037,3352,11235,46503,72065,14840,14052,79661,2495,58038,64429,73828,5602,69838,75147,66352,46980,3725,81063,69950,62820,34436,32653,22972,69435,19181,69557,58554,28757,71611,33128,28773,69850,52706,38795,12256,2770,43611,73562,66559,18917,56373,73441,32356,8140,12262,33790,72073,56200,23841,191,58179,33070,66837,20000,79737,57491,24312,69793,11459,21849,8233,70667,52546,56405,69919,71512,28184,66036,18399,81705,9850,66938,35284,23801,46834,9234,8015,41860,60359,67697,73188,76042,47047,12191,4644,16876,64528,78772,52820,36808,46148,10816,76779,55692,16392,12197,35664,45338,47166,36054,34094,38614,5777,45297,4158,38686,40093,48917,49257,32956,68824,70589,71691,24323,42182,35479,18179,42558,36336,55857,24632,34573,65095,53327,39087,1238,64385,15310,78484,37,22328,34714,33736,46336,53485,11137,46729,57751,16816,7771,47595,57478,41583,64446,77237,58084,48806,66754,13295,52097,16062,80198,75393,70957,31188,52212,19245,62513,52385,68845,10197,2346,48037,61631,54419,24500,27981,30298,12886,49592,75286,24653,58662,80231,77041,58536,20178,70706,733,72446,41547,47288,75427,77775,51671,10148,2459,40880,62619,9038,8467,13232,64311,55135,9056,17046,14137,12225,11462,37359,22464,61986,31187,47042,70822,9086,3184,71966,9896,51315,28210,31494,29093,34630,21861,70273,43110,17822,55450,32467,75124,31923,50517,42119,47693,57252,55897,62470,83518,5669,78304,83209,13278,48688,48061,16749,83786,39533,26071,39875,20110,57070,44248,72093,75119,6073,54959,28427,55131,72857,54392,53872,68864,23946,36155,49378,67159,79601,30219,26861,69087,78603,23900,51778,56452,59466,12861,4823,13015,40674,11371,73775,69516,15546,31389,77610,43431,72253,57509,32891,70698,43854,62657,36536,76085,15914,75367,21018,20494,14806,7234,59178,44559,74824,1581,63594,65409,71568,64261,50078,53476,49088,4036,83794,80893,35860,44886,75794,32102,46656,18265,64773,78207,4124,31868,19610,6500,66043,54589,58590,45915,73421,13437,25908,41975,63542,50012,50180,73930,26056,46806,33436,15994,66562,34427,70604,64760,10997,83258,13165,55845,47073,62130,15338,54282,76539,82107,60646,30829,54764,34049,59407,45755,6550,71100,10169,26548,56016,1852,28487,27407,19553,49734,49097,50566,42006,54850,56264,16797,78503,13786,56137,36055,39264,71518,59204,10017,1037,38987,75605,68744,79394,58282,58694,76709,31716,78580,73952,55315,10365,26096,163,82381,41049,7058,78549,82644,49063,43748,21523,12433,73050,38430,68269,73593,57867,25169,22990,78014,20086,17471,14881,57060,77029,80977,47735,20949,1688,25417,37935,43549,6465,54055,1202,47227,13500,13694,2902,50203,23878,22519,8412,66806,28692,73485,6393,19739,82063,2128,19230,69444,65711,27769,32511,49161,43522,35837,10457,79331,70496,13286,5567,57850,21760,54989,14565,28479,70528,9764,44723,77894,75534,39598,24197,66610,29144,44857,10345,7177,17931,27613,70801,69478,72529,48252,74928,32375,21889,46071,35131,77601,81382,29560,83552,12487,14306,41145,80973,27055,58295,41423,82056,50419,42345,33379,59228,49616,30404,54020,73695,78321,2137,65760,27656,39668,48173,4422,51870,25206,45318,28247,53822,63807,68366,68197,39277,54247,64551,28720,49283,82895,79518,23514,83702,27658,50008,29500,26795,65791,18964,45920,14790,8995,39600,34537,47937,51517,58778,4103,7779,4474,67267,46594,35649,52269,60492,79459,56408,948,1262,19503,44677,9036,82608,31905,41938,41214,15298,16444,27594,57052,35669,71188,42724,49746,26656,23009,7282,53895,18812,20409,82242,82748,79857,2043,2185,60477,1909,69734,44353,23576,66318,40162,67723,38646,2255,84453,24202,7979,24702,58549,2907,76053,19436,36211,974,51201,30197,82083,21047,1462,39731,35959,49830,38531,83553,17657,47210,10091,45693,23934,58596,76935};

/* multiplication inverses of omega */
static const __m256i w_3_inv[2]={{76774,76774,76774,76774},{7706,7706,7706,7706}};

static const __m256i w_5_inv[4][4]={{{83408,83408,83408,83408},{53076,53076,53076,53076},{74127,74127,74127,74127},{42831,42831,42831,42831}},
{{53076,53076,53076,53076},{42831,42831,42831,42831},{83408,83408,83408,83408},{74127,74127,74127,74127}},
{{74127,74127,74127,74127},{83408,83408,83408,83408},{42831,42831,42831,42831},{53076,53076,53076,53076}},
{{42831,42831,42831,42831},{74127,74127,74127,74127},{53076,53076,53076,53076},{83408,83408,83408,83408}}};

/* (in Montgomery form) */
static const uint64_t omega_256_inv[128]={17402,47210,39731,974,24702,67723,1909,82242,26656,27594,82608,56408,67267,47937,18964,83702,64551,53822,48173,73695,42345,80973,81382,74928,17931,24197,70528,5567,43522,19230,28692,2902,6465,47735,20086,68269,49063,163,31716,75605,39264,56264,19553,10169,54764,15338,10997,33436,63542,58590,4124,75794,49088,63594,14806,36536,72253,73775,59466,26861,23946,28427,57070,16749,5669,42119,17822,31494,9086,37359,55135,40880,47288,58536,49592,61631,62513,80198,58084,7771,46336,15310,34573,35479,32956,45297,45338,10816,16876,67697,23801,66036,70667,57491,191,8140,73562,69850,69557,62820,75147,2495,11235,2002,3936,65128,74874,63399,10034,83953,22171,2319,74946,2775,28918,66053,56353,29096,658,37331,78711,42923,16702,45243,6325,81134,30301,84301};
static const uint64_t omega_768_inv[768]={17402,58596,45693,47210,83553,49830,39731,21047,30197,974,19436,2907,24702,24202,2255,67723,66318,44353,1909,2185,79857,82242,18812,7282,26656,42724,35669,27594,15298,41938,82608,44677,1262,56408,60492,35649,67267,7779,58778,47937,39600,14790,18964,26795,50008,83702,79518,49283,64551,39277,68366,53822,45318,51870,48173,27656,2137,73695,30404,59228,42345,82056,58295,80973,14306,83552,81382,35131,21889,74928,72529,70801,17931,10345,29144,24197,75534,44723,70528,14565,21760,5567,70496,10457,43522,32511,65711,19230,82063,6393,28692,8412,23878,2902,13500,1202,6465,37935,1688,47735,77029,14881,20086,22990,57867,68269,73050,21523,49063,78549,41049,163,10365,73952,31716,58694,79394,75605,1037,59204,39264,56137,78503,56264,42006,49097,19553,28487,56016,10169,6550,59407,54764,60646,76539,15338,47073,13165,10997,70604,66562,33436,26056,50180,63542,25908,73421,58590,66043,19610,4124,64773,46656,75794,35860,83794,49088,50078,71568,63594,74824,59178,14806,21018,15914,36536,43854,32891,72253,77610,15546,73775,40674,4823,59466,51778,78603,26861,79601,49378,23946,53872,72857,28427,6073,72093,57070,39875,39533,16749,48688,83209,5669,62470,57252,42119,31923,32467,17822,70273,34630,31494,51315,71966,9086,47042,61986,37359,12225,17046,55135,13232,9038,40880,10148,77775,47288,72446,70706,58536,80231,24653,49592,30298,24500,61631,2346,68845,62513,52212,70957,80198,52097,66754,58084,64446,57478,7771,57751,11137,46336,34714,37,15310,1238,53327,34573,55857,42558,35479,24323,70589,32956,48917,38686,45297,38614,36054,45338,12197,55692,10816,36808,78772,16876,12191,76042,67697,41860,9234,23801,66938,81705,66036,71512,56405,70667,21849,69793,57491,20000,33070,191,56200,33790,8140,73441,18917,73562,2770,38795,69850,33128,28757,69557,69435,32653,62820,81063,46980,75147,5602,64429,2495,14052,72065,11235,80037,63109,2002,24684,771,3936,82879,26666,65128,81669,19174,74874,2236,75844,63399,60351,6988,10034,42020,29774,83953,16699,21149,22171,47769,18033,2319,75939,22794,74946,11479,69120,2775,49997,8369,28918,58545,49706,66053,42014,50124,56353,21751,36092,29096,18035,23696,658,21110,69965,37331,50871,57208,78711,82966,69515,42923,8415,13703,16702,10974,35971,45243,52802,41097,6325,62203,33536,81134,3294,63823,30301,14325,75431,84301,19133,16810,67079,25885,38788,37271,928,34651,44750,63434,54284,83507,65045,81574,59779,60279,82226,16758,18163,40128,82572,82296,4624,2239,65669,77199,57825,41757,48812,56887,69183,42543,1873,39804,83219,28073,23989,48832,17214,76702,25703,36544,44881,69691,65517,57686,34473,779,4963,35198,19930,45204,16115,30659,39163,32611,36308,56825,82344,10786,54077,25253,42136,2425,26186,3508,70175,929,3099,49350,62592,9553,11952,13680,66550,74136,55337,60284,8947,39758,13953,69916,62721,78914,13985,74024,40959,51970,18770,65251,2418,78088,55789,76069,60603,81579,70981,83279,78016,46546,82793,36746,7452,69600,64395,61491,26614,16212,11431,62958,35418,5932,43432,84318,74116,10529,52765,25787,5087,8876,83444,25277,45217,28344,5978,28217,42475,35384,64928,55994,28465,74312,77931,25074,29717,23835,7942,69143,37408,71316,73484,13877,17919,51045,58425,34301,20939,58573,11060,25891,18438,64871,80357,19708,37825,8687,48621,687,35393,34403,12913,20887,9657,25303,69675,63463,68567,47945,40627,51590,12228,6871,68935,10706,43807,79658,25015,32703,5878,57620,4880,35103,60535,30609,11624,56054,78408,12388,27411,44606,44948,67732,35793,1272,78812,22011,27229,42362,52558,52014,66659,14208,49851,52987,33166,12515,75395,37439,22495,47122,72256,67435,29346,71249,75443,43601,74333,6706,37193,12035,13775,25945,4250,59828,34889,54183,59981,22850,82135,15636,21968,32269,13524,4283,32384,17727,26397,20035,27003,76710,26730,73344,38145,49767,84444,69171,83243,31154,49908,28624,41923,49002,60158,13892,51525,35564,45795,39184,45867,48427,39143,72284,28789,73665,47673,5709,67605,72290,8439,16784,42621,75247,60680,17543,2776,18445,12969,28076,13814,62632,14688,26990,64481,51411,84290,28281,50691,76341,11040,65564,10919,81711,45686,14631,51353,55724,14924,15046,51828,21661,3418,37501,9334,78879,20052,81986,70429,12416,73246,4444,21372,82479,59797,83710,80545,1602,57815,19353,2812,65307,9607,82245,8637,21082,24130,77493,74447,42461,54707,528,67782,63332,62310,36712,66448,82162,8542,61687,9535,73002,15361,81706,34484,76112,55563,25936,34775,18428,42467,34357,28128,62730,48389,55385,66446,60785,83823,63371,14516,47150,33610,27273,5770,1515,14966,41558,76066,70778,67779,73507,48510,39238,31679,43384,78156,22278,50945,3347,81187,20658,54180,70156,9050,180,65348,67671};
static const uint64_t omega_1280_inv[1280]={17402,50796,8982,53618,9481,47210,61635,40446,50979,42693,39731,59145,74792,76511,41400,974,43700,47962,36741,31853,24702,38316,82395,68605,44732,67723,9670,66792,19594,14182,1909,52517,25482,60128,55058,82242,48730,2330,60824,21233,26656,27106,65684,66159,31786,27594,71099,29127,51582,16665,82608,31671,59037,75671,76397,56408,29014,50155,68173,48248,67267,69702,9990,45414,10545,47937,25211,36520,31305,76096,18964,61550,1244,83743,48247,83702,46234,50805,30029,11387,64551,16713,54057,59882,42980,53822,35981,19265,14513,53189,48173,32677,83703,29799,74273,73695,26772,63709,99,62555,42345,14403,2457,1123,44834,80973,37938,43231,68206,12779,81382,74503,10809,17628,53650,74928,37857,22770,25880,24035,17931,58224,4847,5138,37970,24197,58853,58395,66816,47559,70528,36121,83833,5274,83797,5567,83759,38730,36785,69042,43522,16557,83487,31557,74045,19230,82852,76619,40521,1088,28692,19922,30286,11642,13195,2902,37395,12450,81713,41302,6465,24823,77225,49669,29888,47735,50322,26920,81278,9642,20086,38338,58749,78015,76093,68269,75627,39208,37588,50773,49063,20740,18935,31279,81001,163,24487,23639,21154,57806,31716,79791,33478,13823,72885,75605,62854,28178,19412,48517,39264,46519,13285,44410,37490,56264,30186,50003,31863,29314,19553,12169,53493,36312,70545,10169,60384,71748,7418,75734,54764,14234,76580,5638,15127,15338,11274,63124,68221,19697,10997,53645,72622,4998,57883,33436,28245,16520,15734,8051,63542,41352,29525,15489,64019,58590,72269,61845,52817,79361,4124,60303,51287,49573,2509,75794,82436,70618,77629,83928,49088,32270,14268,24676,43221,63594,31542,67127,5134,19229,14806,53151,81336,70184,29534,36536,21788,29179,41772,54267,72253,71362,15253,56553,11407,73775,63668,82567,29658,26140,59466,36979,6449,34340,39661,26861,37171,61207,62703,59914,23946,44469,81597,4699,72050,28427,66666,62860,14049,75739,57070,47093,41467,82563,10917,16749,53764,59920,9817,16315,5669,12528,66998,13224,33173,42119,11549,20992,16884,31545,17822,75538,65746,60961,50625,31494,11197,61404,35286,36655,9086,33998,204,26500,56536,37359,12743,81675,74465,43972,55135,83962,81665,69853,62735,40880,14593,5604,67031,62236,47288,46920,12368,77687,59989,58536,30468,61788,60321,8900,49592,28168,14800,67280,25009,61631,21705,41588,36991,62672,62513,56767,42519,27067,30801,80198,18432,18946,19456,1225,58084,24760,14377,7362,66803,7771,18887,59830,52790,16220,46336,64055,58297,72307,28682,15310,49049,81868,28307,11322,34573,11951,3640,73629,13229,35479,74978,60917,13436,12674,32956,60312,72334,7342,57579,45297,74858,5573,69630,10576,45338,76871,38470,1354,49994,10816,71545,48964,42666,61071,16876,78544,83521,64134,27147,67697,14575,47991,67012,36577,23801,62076,57977,9204,37731,66036,25747,13384,22484,79835,70667,32643,51126,76697,25806,57491,55400,37218,49091,67446,191,71193,4895,61068,66181,8140,37004,17979,29673,33058,73562,16121,68262,21710,43894,69850,27559,54957,52557,43930,69557,27597,21794,15050,13618,62820,80082,66310,50,23060,75147,71275,8921,42381,14110,2495,52441,7327,50661,31201,11235,28241,82260,6343,2349,2002,44720,11500,65978,49686,3936,24286,32315,35022,66964,65128,80071,78133,79826,49620,74874,80537,22713,33384,38055,63399,26089,52841,22845,60470,10034,82603,29365,26178,26303,83953,60618,27603,7665,71377,22171,70649,75030,51107,51038,2319,72647,16528,53216,26833,74946,79951,22789,51539,47522,2775,12615,73330,27396,30470,28918,22776,11751,80362,26484,66053,84276,74416,4477,3456,56353,3648,26630,32011,46883,29096,54181,49486,80658,61622,658,83819,66402,8688,70091,37331,50518,15938,34551,35597,78711,42268,12683,54003,18081,42923,61326,50001,64733,66859,16702,65880,55177,69540,53549,45243,33057,5516,77134,24596,6325,44736,1983,19061,72494,81134,10814,19934,2028,39815,30301,18560,27291,66525,14727,84301,1465,84291,81334,18573,67079,33685,75499,30863,75000,37271,22846,44035,33502,41788,44750,25336,9689,7970,43081,83507,40781,36519,47740,52628,59779,46165,2086,15876,39749,16758,74811,17689,64887,70299,82572,31964,58999,24353,29423,2239,35751,82151,23657,63248,57825,57375,18797,18322,52695,56887,13382,55354,32899,67816,1873,52810,25444,8810,8084,28073,55467,34326,16308,36233,17214,14779,74491,39067,73936,36544,59270,47961,53176,8385,65517,22931,83237,738,36234,779,38247,33676,54452,73094,19930,67768,30424,24599,41501,30659,48500,65216,69968,31292,36308,51804,778,54682,10208,10786,57709,20772,84382,21926,42136,70078,82024,83358,39647,3508,46543,41250,16275,71702,3099,9978,73672,66853,30831,9553,46624,61711,58601,60446,66550,26257,79634,79343,46511,60284,25628,26086,17665,36922,13953,48360,648,79207,684,78914,722,45751,47696,15439,40959,67924,994,52924,10436,65251,1629,7862,43960,83393,55789,64559,54195,72839,71286,81579,47086,72031,2768,43179,78016,59658,7256,34812,54593,36746,34159,57561,3203,74839,64395,46143,25732,6466,8388,16212,8854,45273,46893,33708,35418,63741,65546,53202,3480,84318,59994,60842,63327,26675,52765,4690,51003,70658,11596,8876,21627,56303,65069,35964,45217,37962,71196,40071,46991,28217,54295,34478,52618,55167,64928,72312,30988,48169,13936,74312,24097,12733,77063,8747,29717,70247,7901,78843,69354,69143,73207,21357,16260,64784,73484,30836,11859,79483,26598,51045,56236,67961,68747,76430,20939,43129,54956,68992,20462,25891,12212,22636,31664,5120,80357,24178,33194,34908,81972,8687,2045,13863,6852,553,35393,52211,70213,59805,41260,20887,52939,17354,79347,65252,69675,31330,3145,14297,54947,47945,62693,55302,42709,30214,12228,13119,69228,27928,73074,10706,20813,1914,54823,58341,25015,47502,78032,50141,44820,57620,47310,23274,21778,24567,60535,40012,2884,79782,12431,56054,17815,21621,70432,8742,27411,37388,43014,1918,73564,67732,30717,24561,74664,68166,78812,71953,17483,71257,51308,42362,72932,63489,67597,52936,66659,8943,18735,23520,33856,52987,73284,23077,49195,47826,75395,50483,84277,57981,27945,47122,71738,2806,10016,40509,29346,519,2816,14628,21746,43601,69888,78877,17450,22245,37193,37561,72113,6794,24492,25945,54013,22693,24160,75581,34889,56313,69681,17201,59472,22850,62776,42893,47490,21809,21968,27714,41962,57414,53680,4283,66049,65535,65025,83256,26397,59721,70104,77119,17678,76710,65594,24651,31691,68261,38145,20426,26184,12174,55799,69171,35432,2613,56174,73159,49908,72530,80841,10852,71252,49002,9503,23564,71045,71807,51525,24169,12147,77139,26902,39184,9623,78908,14851,73905,39143,7610,46011,83127,34487,73665,12936,35517,41815,23410,67605,5937,960,20347,57334,16784,69906,36490,17469,47904,60680,22405,26504,75277,46750,18445,58734,71097,61997,4646,13814,51838,33355,7784,58675,26990,29081,47263,35390,17035,84290,13288,79586,23413,18300,76341,47477,66502,54808,51423,10919,68360,16219,62771,40587,14631,56922,29524,31924,40551,14924,56884,62687,69431,70863,21661,4399,18171,84431,61421,9334,13206,75560,42100,70371,81986,32040,77154,33820,53280,73246,56240,2221,78138,82132,82479,39761,72981,18503,34795,80545,60195,52166,49459,17517,19353,4410,6348,4655,34861,9607,3944,61768,51097,46426,21082,58392,31640,61636,24011,74447,1878,55116,58303,58178,528,23863,56878,76816,13104,62310,13832,9451,33374,33443,82162,11834,67953,31265,57648,9535,4530,61692,32942,36959,81706,71866,11151,57085,54011,55563,61705,72730,4119,57997,18428,205,10065,80004,81025,28128,80833,57851,52470,37598,55385,30300,34995,3823,22859,83823,662,18079,75793,14390,47150,33963,68543,49930,48884,5770,42213,71798,30478,66400,41558,23155,34480,19748,17622,67779,18601,29304,14941,30932,39238,51424,78965,7347,59885,78156,39745,82498,65420,11987,3347,73667,64547,82453,44666,54180,65921,57190,17956,69754,180,83016,190,3147,65908};

static const __m256i V_B4Q_B4Q_B4Q_B4Q = {BARRETT_FACTOR_4Q, BARRETT_FACTOR_4Q, BARRETT_FACTOR_4Q, BARRETT_FACTOR_4Q};
static const __m256i V_B8Q_B8Q_B8Q_B8Q = {BARRETT_FACTOR_8Q, BARRETT_FACTOR_8Q, BARRETT_FACTOR_8Q, BARRETT_FACTOR_8Q};
static const __m256i V_B16Q_B16Q_B16Q_B16Q = {BARRETT_FACTOR_16Q, BARRETT_FACTOR_16Q, BARRETT_FACTOR_16Q, BARRETT_FACTOR_16Q};
static const __m256i V_Q_Q_Q_Q = {Q, Q, Q, Q};
static const __m256i V_Q2_Q2_Q2_Q2 = {Q2, Q2, Q2, Q2};
static const __m256i V_MM_MM_MM_MM = {MONTGOMERY_MASK, MONTGOMERY_MASK, MONTGOMERY_MASK, MONTGOMERY_MASK};
static const __m256i V_MF_MF_MF_MF = {MONTGOMERY_FACTOR, MONTGOMERY_FACTOR, MONTGOMERY_FACTOR, MONTGOMERY_FACTOR};

/* bit reverse step of dimension 256 */
static void bit_reverse_256(uint64_t *a)
{
uint64_t t;
t=a[1];a[1]=a[128];a[128]=t;
t=a[2];a[2]=a[64];a[64]=t;
t=a[3];a[3]=a[192];a[192]=t;
t=a[4];a[4]=a[32];a[32]=t;
t=a[5];a[5]=a[160];a[160]=t;
t=a[6];a[6]=a[96];a[96]=t;
t=a[7];a[7]=a[224];a[224]=t;
t=a[8];a[8]=a[16];a[16]=t;
t=a[9];a[9]=a[144];a[144]=t;
t=a[10];a[10]=a[80];a[80]=t;
t=a[11];a[11]=a[208];a[208]=t;
t=a[12];a[12]=a[48];a[48]=t;
t=a[13];a[13]=a[176];a[176]=t;
t=a[14];a[14]=a[112];a[112]=t;
t=a[15];a[15]=a[240];a[240]=t;
t=a[17];a[17]=a[136];a[136]=t;
t=a[18];a[18]=a[72];a[72]=t;
t=a[19];a[19]=a[200];a[200]=t;
t=a[20];a[20]=a[40];a[40]=t;
t=a[21];a[21]=a[168];a[168]=t;
t=a[22];a[22]=a[104];a[104]=t;
t=a[23];a[23]=a[232];a[232]=t;
t=a[25];a[25]=a[152];a[152]=t;
t=a[26];a[26]=a[88];a[88]=t;
t=a[27];a[27]=a[216];a[216]=t;
t=a[28];a[28]=a[56];a[56]=t;
t=a[29];a[29]=a[184];a[184]=t;
t=a[30];a[30]=a[120];a[120]=t;
t=a[31];a[31]=a[248];a[248]=t;
t=a[33];a[33]=a[132];a[132]=t;
t=a[34];a[34]=a[68];a[68]=t;
t=a[35];a[35]=a[196];a[196]=t;
t=a[37];a[37]=a[164];a[164]=t;
t=a[38];a[38]=a[100];a[100]=t;
t=a[39];a[39]=a[228];a[228]=t;
t=a[41];a[41]=a[148];a[148]=t;
t=a[42];a[42]=a[84];a[84]=t;
t=a[43];a[43]=a[212];a[212]=t;
t=a[44];a[44]=a[52];a[52]=t;
t=a[45];a[45]=a[180];a[180]=t;
t=a[46];a[46]=a[116];a[116]=t;
t=a[47];a[47]=a[244];a[244]=t;
t=a[49];a[49]=a[140];a[140]=t;
t=a[50];a[50]=a[76];a[76]=t;
t=a[51];a[51]=a[204];a[204]=t;
t=a[53];a[53]=a[172];a[172]=t;
t=a[54];a[54]=a[108];a[108]=t;
t=a[55];a[55]=a[236];a[236]=t;
t=a[57];a[57]=a[156];a[156]=t;
t=a[58];a[58]=a[92];a[92]=t;
t=a[59];a[59]=a[220];a[220]=t;
t=a[61];a[61]=a[188];a[188]=t;
t=a[62];a[62]=a[124];a[124]=t;
t=a[63];a[63]=a[252];a[252]=t;
t=a[65];a[65]=a[130];a[130]=t;
t=a[67];a[67]=a[194];a[194]=t;
t=a[69];a[69]=a[162];a[162]=t;
t=a[70];a[70]=a[98];a[98]=t;
t=a[71];a[71]=a[226];a[226]=t;
t=a[73];a[73]=a[146];a[146]=t;
t=a[74];a[74]=a[82];a[82]=t;
t=a[75];a[75]=a[210];a[210]=t;
t=a[77];a[77]=a[178];a[178]=t;
t=a[78];a[78]=a[114];a[114]=t;
t=a[79];a[79]=a[242];a[242]=t;
t=a[81];a[81]=a[138];a[138]=t;
t=a[83];a[83]=a[202];a[202]=t;
t=a[85];a[85]=a[170];a[170]=t;
t=a[86];a[86]=a[106];a[106]=t;
t=a[87];a[87]=a[234];a[234]=t;
t=a[89];a[89]=a[154];a[154]=t;
t=a[91];a[91]=a[218];a[218]=t;
t=a[93];a[93]=a[186];a[186]=t;
t=a[94];a[94]=a[122];a[122]=t;
t=a[95];a[95]=a[250];a[250]=t;
t=a[97];a[97]=a[134];a[134]=t;
t=a[99];a[99]=a[198];a[198]=t;
t=a[101];a[101]=a[166];a[166]=t;
t=a[103];a[103]=a[230];a[230]=t;
t=a[105];a[105]=a[150];a[150]=t;
t=a[107];a[107]=a[214];a[214]=t;
t=a[109];a[109]=a[182];a[182]=t;
t=a[110];a[110]=a[118];a[118]=t;
t=a[111];a[111]=a[246];a[246]=t;
t=a[113];a[113]=a[142];a[142]=t;
t=a[115];a[115]=a[206];a[206]=t;
t=a[117];a[117]=a[174];a[174]=t;
t=a[119];a[119]=a[238];a[238]=t;
t=a[121];a[121]=a[158];a[158]=t;
t=a[123];a[123]=a[222];a[222]=t;
t=a[125];a[125]=a[190];a[190]=t;
t=a[127];a[127]=a[254];a[254]=t;
t=a[131];a[131]=a[193];a[193]=t;
t=a[133];a[133]=a[161];a[161]=t;
t=a[135];a[135]=a[225];a[225]=t;
t=a[137];a[137]=a[145];a[145]=t;
t=a[139];a[139]=a[209];a[209]=t;
t=a[141];a[141]=a[177];a[177]=t;
t=a[143];a[143]=a[241];a[241]=t;
t=a[147];a[147]=a[201];a[201]=t;
t=a[149];a[149]=a[169];a[169]=t;
t=a[151];a[151]=a[233];a[233]=t;
t=a[155];a[155]=a[217];a[217]=t;
t=a[157];a[157]=a[185];a[185]=t;
t=a[159];a[159]=a[249];a[249]=t;
t=a[163];a[163]=a[197];a[197]=t;
t=a[167];a[167]=a[229];a[229]=t;
t=a[171];a[171]=a[213];a[213]=t;
t=a[173];a[173]=a[181];a[181]=t;
t=a[175];a[175]=a[245];a[245]=t;
t=a[179];a[179]=a[205];a[205]=t;
t=a[183];a[183]=a[237];a[237]=t;
t=a[187];a[187]=a[221];a[221]=t;
t=a[191];a[191]=a[253];a[253]=t;
t=a[199];a[199]=a[227];a[227]=t;
t=a[203];a[203]=a[211];a[211]=t;
t=a[207];a[207]=a[243];a[243]=t;
t=a[215];a[215]=a[235];a[235]=t;
t=a[223];a[223]=a[251];a[251]=t;
t=a[239];a[239]=a[247];a[247]=t;
}

/* DIF radix-2 NTT */
static void ntt_2(uint64_t *a, uint32_t n, const uint64_t *omega)
{
	uint32_t num_of_problems = 1;
	uint32_t d = n >> 1;
	uint32_t j1, j2, j_omega;
	uint32_t k, j;
	
	__m256i u, v, t, t1, o, u1, v1, r1, r2;

	while (d > 2)
	{
		for (k = 0; k < num_of_problems; k++)
		{
			/* Gentleman-Sande's butterfly
			 * (u, v) <-- (u + v, (u - v) * omega) % Q
			 * where omega = 1 (save 1 multiplication) */
			j1 = 2 * k * d;
			j2 = j1 + d;
			
			j_omega = 0;

			for (j = j1; j < j2; j += 4)
			{
				/* Gentleman-Sande's butterfly
				 * (u, v) <-- (u + v, (u - v) * omega) % Q */
				u = _mm256_loadu_si256((__m256i *)(a + j));
				v = _mm256_loadu_si256((__m256i *)(a + j + d));
				
				t = _mm256_add_epi64(u, v);
				t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
				t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
				t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
				r1 = _mm256_sub_epi64(t, t1);
				
				t = _mm256_add_epi64(V_Q2_Q2_Q2_Q2, u);
				t = _mm256_sub_epi64(t, v);
				o = _mm256_set_epi64x(omega[j_omega + num_of_problems * 3], omega[j_omega + num_of_problems * 2], omega[j_omega + num_of_problems], omega[j_omega]);
				t = _mm256_mul_epu32(t, o);
				t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
				t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
				t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
				t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
				t1 = _mm256_add_epi64(t, t1);
				r2 = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);

				_mm256_storeu_si256((__m256i *)(a + j), r1);
				_mm256_storeu_si256((__m256i *)(a + j + d), r2);

				j_omega += num_of_problems * 4;
			} 
		}
		
		num_of_problems <<= 1;
		d >>= 1;
	}
	
	/* last 2 levels (save some overhead of iterations) */
	for (k = 0; k < num_of_problems; k += 2)
	{
		j = k << 2;
		
		u1 = _mm256_loadu_si256((__m256i *)(a + j));
		v1 = _mm256_loadu_si256((__m256i *)(a + j + 4));
		u = _mm256_permute2f128_si256(u1, v1, 0x20);
		v = _mm256_permute2f128_si256(u1, v1, 0x31);
		
		t = _mm256_add_epi64(u, v);
		t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
		t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		r1 = _mm256_sub_epi64(t, t1);
		
		t = _mm256_add_epi64(V_Q2_Q2_Q2_Q2, u);
		t = _mm256_sub_epi64(t, v);
		o = _mm256_set_epi64x(omega[num_of_problems], omega[0], omega[num_of_problems], omega[0]);
		t = _mm256_mul_epu32(t, o);
		t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
		t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		t1 = _mm256_add_epi64(t, t1);
		r2 = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
		
		u = _mm256_permute2f128_si256(r1, r2, 0x20);
		v = _mm256_permute2f128_si256(r1, r2, 0x31);
		
		_mm256_storeu_si256((__m256i *)(a + j), u);
		_mm256_storeu_si256((__m256i *)(a + j + 4), v);
	}
	
	for (k = 0; k < (n >> 1); k += 4)
	{
		j = k << 1;
		
		u1 = _mm256_loadu_si256((__m256i *)(a + j));
		v1 = _mm256_loadu_si256((__m256i *)(a + j + 4));
		u1 = _mm256_permute4x64_epi64(u1, 0xD8);
		v1 = _mm256_permute4x64_epi64(v1, 0xD8);
		u = _mm256_permute2f128_si256(u1, v1, 0x20);
		v = _mm256_permute2f128_si256(u1, v1, 0x31);
		
		t = _mm256_add_epi64(u, v);
		t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
		t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		r1 = _mm256_sub_epi64(t, t1);

		t = _mm256_add_epi64(V_Q2_Q2_Q2_Q2, u);
		t = _mm256_sub_epi64(t, v);
		t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
		t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		r2 = _mm256_sub_epi64(t, t1);

		u1 = _mm256_permute2f128_si256(r1, r2, 0x20);
		v1 = _mm256_permute2f128_si256(r1, r2, 0x31);
		u = _mm256_permute4x64_epi64(u1, 0xD8);
		v = _mm256_permute4x64_epi64(v1, 0xD8);
		
		_mm256_storeu_si256((__m256i *)(a + j), u);
		_mm256_storeu_si256((__m256i *)(a + j + 4), v);
	}
}

/* Partial NTT similar to Sorensen et al.'s work:
 * Efficient computation of the DFT with only a subset of input or output points
 * X(k1+N1k2)=sum_n2^{N2-1} [omega_N^{n2k1}](sum_n1^{N1-1} x(N2n1+n2)omega_N1^{n1k1})omega_N2^{n2k2}
 * http://ieeexplore.ieee.org/document/205723/
 * 
 * ntt_butterfly is the function of the "partial" subroutine of NTT
 * Note: we exclusively use DIF NTT from natural order input to bit-reversed order output (DIF_N-->DIF_R) for both NTT and Inverse-NTT,
 * because DIF_R-->DIF_N may not be able to be efficiently parallelized due to its non-consecutive memory access at each iteration */
static void ntt_core(uint64_t *a, uint32_t N1, uint32_t N2, const uint64_t *omega_2, const uint64_t *omega_n, void (*ntt_butterfly)(uint64_t *, uint32_t))
{
	uint32_t n1, n2;
	__m256i u, v, t, t1;
	
	/* y_k1(n2)=sum_n1^{N1-1} x(N2n1+n2)omega_N1^{n1k1} */
	for (n2 = 0; n2 < N2; n2 += 4)
	{
		ntt_butterfly(a, n2);
	}
	
	/* multiply each a coordinate by corresponding twiddle factors 
	 * we don't need to multiply with those twiddle factors which is equal to 1 */
	for (n1 = 1; n1 < N1; n1++)
	{
		for (n2 = 0; n2 < N2; n2 += 4)
		{
			u = _mm256_loadu_si256((__m256i *)(a + N2 * n1 + n2));
			v = _mm256_set_epi64x(omega_n[n1 * (n2 + 3)], omega_n[n1 * (n2 + 2)], omega_n[n1 * (n2 + 1)], omega_n[n1 * n2]);
			
			t = _mm256_mul_epu32(u, v);
			t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
			t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
			t1 = _mm256_add_epi64(t, t1);
			u = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
			
			_mm256_storeu_si256((__m256i *)(a + N2 * n1 + n2), u);
		}
	}
	
    /* sum_n2^{N2-1} [omega_N^{n2k1}]y_k1(n2)omega_N2^{n2k2} */
	for (n1 = 0; n1 < N1; n1++)
	{
		ntt_2(a + N2 * n1, N2, omega_2);
		bit_reverse_256(a + N2 * n1);
	}
}

/* Inverse-NTT, which is the NTT in "reversed order" of each step 
 * X(k2+N2k1)=sum_n1^{N1-1} [omega_N^{-n1k2}](sum_n2^{N2-1} x(N1n2+n1)omega_N2^{-n2k2})omega_N1^{-n1k1} */
static void intt_core(uint64_t *a, uint32_t N1, uint32_t N2, uint32_t DIM, const uint64_t *omega_2, const uint64_t *omega_n, void (*ntt_butterfly)(uint64_t *, uint32_t), uint64_t inv_n)
{
	uint32_t i, n1, n2;
	__m256i u, v, t, t1;
	
	for (n1 = 0; n1 < N1; n1++)
	{
		ntt_2(a + N2 * n1, N2, omega_2);
		bit_reverse_256(a + N2 * n1);
	}
	
	for (n1 = 1; n1 < N1; n1++)
	{
		for (n2 = 0; n2 < N2; n2 += 4)
		{
			u = _mm256_loadu_si256((__m256i *)(a + N2 * n1 + n2));
			v = _mm256_set_epi64x(omega_n[n1 * (n2 + 3)], omega_n[n1 * (n2 + 2)], omega_n[n1 * (n2 + 1)], omega_n[n1 * n2]);
			
			t = _mm256_mul_epu32(u, v);
			t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
			t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
			t1 = _mm256_add_epi64(t, t1);
			u = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
			
			_mm256_storeu_si256((__m256i *)(a + N2 * n1 + n2), u);
		}
	}
	
	for (n2 = 0; n2 < N2; n2 += 4)
	{
		ntt_butterfly(a, n2);
	}
	
	/* multiply each a coordinate by the multiplication inverse of the dimension n */
	for (i = 0; i < DIM; i += 4)
	{
		u = _mm256_loadu_si256((__m256i *)(a + i));
		v = _mm256_set1_epi64x(inv_n);
		
		t = _mm256_mul_epu32(u, v);
		t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
		t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		t1 = _mm256_add_epi64(t, t1);
		u = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
			
		_mm256_storeu_si256((__m256i *)(a + i), u);
	}
}

/* 256 * 4 --> 256 * 6 */
static void ntt_butterfly_1024_1536(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, c1, d1, e1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	

	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);
	_mm256_storeu_si256((__m256i *)(a + n2), t);
	
	c1 = _mm256_mul_epu32(c, w_6[0][0]);
	d1 = _mm256_mul_epu32(d, w_6[0][1]);
	e1 = _mm256_mul_epu32(e, w_6[0][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 + n2), t);
	a[N2_1536 + n2] %= Q;
	a[N2_1536 + n2 + 1] %= Q;
	a[N2_1536 + n2 + 2] %= Q;
	a[N2_1536 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_6[1][0]);
	d1 = _mm256_mul_epu32(d, w_6[1][1]);
	e1 = _mm256_mul_epu32(e, w_6[1][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 2 + n2), t);
	a[N2_1536 * 2 + n2] %= Q;
	a[N2_1536 * 2 + n2 + 1] %= Q;
	a[N2_1536 * 2 + n2 + 2] %= Q;
	a[N2_1536 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[2][0]);
	d1 = _mm256_mul_epu32(d, w_6[2][1]);
	e1 = _mm256_mul_epu32(e, w_6[2][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 3 + n2), t);
	a[N2_1536 * 3 + n2] %= Q;
	a[N2_1536 * 3 + n2 + 1] %= Q;
	a[N2_1536 * 3 + n2 + 2] %= Q;
	a[N2_1536 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[3][0]);
	d1 = _mm256_mul_epu32(d, w_6[3][1]);
	e1 = _mm256_mul_epu32(e, w_6[3][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 4 + n2), t);
	a[N2_1536 * 4 + n2] %= Q;
	a[N2_1536 * 4 + n2 + 1] %= Q;
	a[N2_1536 * 4 + n2 + 2] %= Q;
	a[N2_1536 * 4 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[4][0]);
	d1 = _mm256_mul_epu32(d, w_6[4][1]);
	e1 = _mm256_mul_epu32(e, w_6[4][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 5 + n2), t);
	a[N2_1536 * 5 + n2] %= Q;
	a[N2_1536 * 5 + n2 + 1] %= Q;
	a[N2_1536 * 5 + n2 + 2] %= Q;
	a[N2_1536 * 5 + n2 + 3] %= Q;
}

/* 256 * 6 --> 256 * 3 */
static void ntt_butterfly_1536_768(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, g, c1, d1, e1, f1, g1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	
	f = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 4 + n2));	
	g = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 5 + n2));	
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t = _mm256_add_epi64(t, g);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
	
	c1 = _mm256_mul_epu32(c, w_6[0][0]);
	d1 = _mm256_mul_epu32(d, w_6[0][1]);
	e1 = _mm256_mul_epu32(e, w_6[0][2]);
	f1 = _mm256_mul_epu32(f, w_6[0][3]);
	g1 = _mm256_mul_epu32(g, w_6[0][4]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	t = _mm256_add_epi64(t, g1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 + n2), t);
	a[N2_1536 + n2] %= Q;
	a[N2_1536 + n2 + 1] %= Q;
	a[N2_1536 + n2 + 2] %= Q;
	a[N2_1536 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_6[1][0]);
	d1 = _mm256_mul_epu32(d, w_6[1][1]);
	e1 = _mm256_mul_epu32(e, w_6[1][2]);
	f1 = _mm256_mul_epu32(f, w_6[1][3]);
	g1 = _mm256_mul_epu32(g, w_6[1][4]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	t = _mm256_add_epi64(t, g1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 2 + n2), t);
	a[N2_1536 * 2 + n2] %= Q;
	a[N2_1536 * 2 + n2 + 1] %= Q;
	a[N2_1536 * 2 + n2 + 2] %= Q;
	a[N2_1536 * 2 + n2 + 3] %= Q;
}

/* 256 * 2 --> 256 * 5 */
static void ntt_butterfly_512_1280(uint64_t *a, uint32_t n2)
{
	__m256i b, c, c1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_1280 + n2));
	
	t = _mm256_add_epi64(b, c);
	t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_5[0][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 + n2), t);
	a[N2_1280 + n2] %= Q;
	a[N2_1280 + n2 + 1] %= Q;
	a[N2_1280 + n2 + 2] %= Q;
	a[N2_1280 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[1][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 2 + n2), t);
	a[N2_1280 * 2 + n2] %= Q;
	a[N2_1280 * 2 + n2 + 1] %= Q;
	a[N2_1280 * 2 + n2 + 2] %= Q;
	a[N2_1280 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[2][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 3 + n2), t);
	a[N2_1280 * 3 + n2] %= Q;
	a[N2_1280 * 3 + n2 + 1] %= Q;
	a[N2_1280 * 3 + n2 + 2] %= Q;
	a[N2_1280 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[3][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 4 + n2), t);
	a[N2_1280 * 4 + n2] %= Q;
	a[N2_1280 * 4 + n2 + 1] %= Q;
	a[N2_1280 * 4 + n2 + 2] %= Q;
	a[N2_1280 * 4 + n2 + 3] %= Q;
}

/* 256 * 4 --> 256 * 5 */
static void ntt_butterfly_1024_1280(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, c1, d1, e1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_1280 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 2 + n2));
	e = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 3 + n2));

	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_5[0][0]);
	d1 = _mm256_mul_epu32(d, w_5[0][1]);
	e1 = _mm256_mul_epu32(e, w_5[0][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 + n2), t);
	a[N2_1280 + n2] %= Q;
	a[N2_1280 + n2 + 1] %= Q;
	a[N2_1280 + n2 + 2] %= Q;
	a[N2_1280 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_5[1][0]);
	d1 = _mm256_mul_epu32(d, w_5[1][1]);
	e1 = _mm256_mul_epu32(e, w_5[1][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 2 + n2), t);
	a[N2_1280 * 2 + n2] %= Q;
	a[N2_1280 * 2 + n2 + 1] %= Q;
	a[N2_1280 * 2 + n2 + 2] %= Q;
	a[N2_1280 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[2][0]);
	d1 = _mm256_mul_epu32(d, w_5[2][1]);
	e1 = _mm256_mul_epu32(e, w_5[2][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 3 + n2), t);
	a[N2_1280 * 3 + n2] %= Q;
	a[N2_1280 * 3 + n2 + 1] %= Q;
	a[N2_1280 * 3 + n2 + 2] %= Q;
	a[N2_1280 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[3][0]);
	d1 = _mm256_mul_epu32(d, w_5[3][1]);
	e1 = _mm256_mul_epu32(e, w_5[3][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 4 + n2), t);
	a[N2_1280 * 4 + n2] %= Q;
	a[N2_1280 * 4 + n2 + 1] %= Q;
	a[N2_1280 * 4 + n2 + 2] %= Q;
	a[N2_1280 * 4 + n2 + 3] %= Q;
}

/* 256 * 5 --> 256 * 5 */
static void ntt_butterfly_1280_1280_inv(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, c1, d1, e1, f1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_1280 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 2 + n2));
	e = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 3 + n2));
	f = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 4 + n2));

	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_5_inv[0][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[0][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[0][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[0][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 + n2), t);
	a[N2_1280 + n2] %= Q;
	a[N2_1280 + n2 + 1] %= Q;
	a[N2_1280 + n2 + 2] %= Q;
	a[N2_1280 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_5_inv[1][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[1][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[1][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[1][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 2 + n2), t);
	a[N2_1280 * 2 + n2] %= Q;
	a[N2_1280 * 2 + n2 + 1] %= Q;
	a[N2_1280 * 2 + n2 + 2] %= Q;
	a[N2_1280 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5_inv[2][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[2][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[2][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[2][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 3 + n2), t);
	a[N2_1280 * 3 + n2] %= Q;
	a[N2_1280 * 3 + n2 + 1] %= Q;
	a[N2_1280 * 3 + n2 + 2] %= Q;
	a[N2_1280 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5_inv[3][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[3][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[3][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[3][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 4 + n2), t);
	a[N2_1280 * 4 + n2] %= Q;
	a[N2_1280 * 4 + n2 + 1] %= Q;
	a[N2_1280 * 4 + n2 + 2] %= Q;
	a[N2_1280 * 4 + n2 + 3] %= Q;
}

/* 256 * 3 --> 256 * 3 */
static void ntt_butterfly_768_768_inv(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, c1, d1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_768 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_768 * 2 + n2));
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_3_inv[0]);
	d1 = _mm256_mul_epu32(d, w_3_inv[1]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 + n2), t);
	a[N2_768 + n2] %= Q;
	a[N2_768 + n2 + 1] %= Q;
	a[N2_768 + n2 + 2] %= Q;
	a[N2_768 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_3_inv[1]);
	d1 = _mm256_mul_epu32(d, w_3_inv[0]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 * 2 + n2), t);
	a[N2_768 * 2 + n2] %= Q;
	a[N2_768 * 2 + n2 + 1] %= Q;
	a[N2_768 * 2 + n2 + 2] %= Q;
	a[N2_768 * 2 + n2 + 3] %= Q;
}

/* 256 * 2 --> 256 * 3 */
static void ntt_butterfly_512_768(uint64_t *a, uint32_t n2)
{
	__m256i b, c, c1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_768 + n2));
	
	t = _mm256_add_epi64(b, c);
	t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_3[0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 + n2), t);
	a[N2_768 + n2] %= Q;
	a[N2_768 + n2 + 1] %= Q;
	a[N2_768 + n2 + 2] %= Q;
	a[N2_768 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_3[1]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 * 2 + n2), t);
	a[N2_768 * 2 + n2] %= Q;
	a[N2_768 * 2 + n2 + 1] %= Q;
	a[N2_768 * 2 + n2 + 2] %= Q;
	a[N2_768 * 2 + n2 + 3] %= Q;	
}

/* 256 * 3 --> 256 * 1 */
static void ntt_butterfly_768_256(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_768 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_768 * 2 + n2));
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
}

/* 256 * 5 --> 256 * 6 */
static void ntt_butterfly_1280_1536(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, c1, d1, e1, f1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	
	f = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 4 + n2));	
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
	
	c1 = _mm256_mul_epu32(c, w_6[0][0]);
	d1 = _mm256_mul_epu32(d, w_6[0][1]);
	e1 = _mm256_mul_epu32(e, w_6[0][2]);
	f1 = _mm256_mul_epu32(f, w_6[0][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 + n2), t);
	a[N2_1536 + n2] %= Q;
	a[N2_1536 + n2 + 1] %= Q;
	a[N2_1536 + n2 + 2] %= Q;
	a[N2_1536 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[1][0]);
	d1 = _mm256_mul_epu32(d, w_6[1][1]);
	e1 = _mm256_mul_epu32(e, w_6[1][2]);
	f1 = _mm256_mul_epu32(f, w_6[1][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 2 + n2), t);
	a[N2_1536 * 2 + n2] %= Q;
	a[N2_1536 * 2 + n2 + 1] %= Q;
	a[N2_1536 * 2 + n2 + 2] %= Q;
	a[N2_1536 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[2][0]);
	d1 = _mm256_mul_epu32(d, w_6[2][1]);
	e1 = _mm256_mul_epu32(e, w_6[2][2]);
	f1 = _mm256_mul_epu32(f, w_6[2][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 3 + n2), t);
	a[N2_1536 * 3 + n2] %= Q;
	a[N2_1536 * 3 + n2 + 1] %= Q;
	a[N2_1536 * 3 + n2 + 2] %= Q;
	a[N2_1536 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[3][0]);
	d1 = _mm256_mul_epu32(d, w_6[3][1]);
	e1 = _mm256_mul_epu32(e, w_6[3][2]);
	f1 = _mm256_mul_epu32(f, w_6[3][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 4 + n2), t);
	a[N2_1536 * 4 + n2] %= Q;
	a[N2_1536 * 4 + n2 + 1] %= Q;
	a[N2_1536 * 4 + n2 + 2] %= Q;
	a[N2_1536 * 4 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_6[4][0]);
	d1 = _mm256_mul_epu32(d, w_6[4][1]);
	e1 = _mm256_mul_epu32(e, w_6[4][2]);
	f1 = _mm256_mul_epu32(f, w_6[4][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 5 + n2), t);
	a[N2_1536 * 5 + n2] %= Q;
	a[N2_1536 * 5 + n2 + 1] %= Q;
	a[N2_1536 * 5 + n2 + 2] %= Q;
	a[N2_1536 * 5 + n2 + 3] %= Q;
}

/* 256 * 6 --> 256 * 1 */
static void ntt_butterfly_1536_256(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, g, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	
	f = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 4 + n2));	
	g = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 5 + n2));	
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t = _mm256_add_epi64(t, g);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
}

void ntt_1024_1536(uint64_t *a)
{
	ntt_core(a, N1_1536, N2_1536, omega_256, omega_1536, ntt_butterfly_1024_1536);
}

void intt_1536_768(uint64_t *a)
{
	intt_core(a, N1_1536, N2_1536, 768, omega_256, omega_1536, ntt_butterfly_1536_768, INV_1536);
}

void ntt_512_1280(uint64_t *a)
{
	ntt_core(a, N1_1280, N2_1280, omega_256, omega_1280, ntt_butterfly_512_1280);
}

void ntt_1024_1280(uint64_t *a)
{
	ntt_core(a, N1_1280, N2_1280, omega_256, omega_1280, ntt_butterfly_1024_1280);
}

void intt_1280_1280_inv(uint64_t *a)
{
	intt_core(a, N1_1280, N2_1280, 1280, omega_256_inv, omega_1280_inv, ntt_butterfly_1280_1280_inv, INV_1280);
}

void ntt_768_768_inv(uint64_t *a)
{
	ntt_core(a, N1_768, N2_768, omega_256_inv, omega_768_inv, ntt_butterfly_768_768_inv);
}

void ntt_512_768(uint64_t *a)
{
	ntt_core(a, N1_768, N2_768, omega_256, omega_768, ntt_butterfly_512_768);
}

void intt_768_256(uint64_t *a)
{
	intt_core(a, N1_768, N2_768, 256, omega_256, omega_768, ntt_butterfly_768_256, INV_768);
}

void ntt_1280_1536(uint64_t *a)
{
	ntt_core(a, N1_1536, N2_1536, omega_256, omega_1536, ntt_butterfly_1280_1536);
}

void intt_1536_256(uint64_t *a)
{
	intt_core(a, N1_1536, N2_1536, 256, omega_256, omega_1536, ntt_butterfly_1536_256, INV_1536);
}
